---
title: 虚拟内存--基本工作机制
key: 20180728
tags: 虚拟内存
---

在阅读计算机系统方面的书籍时，经常遇到的一个词就是**虚拟内存**。对于现代计算机系统来说，虚拟内存是其重要的组成部分，理解虚拟内存以及其工作机制，对于理解整个计算机工作原理至关重要。但是，不可避免的是虚拟内存也非常复杂，需要逐步的循序渐进地理解它的全貌。

本文是我在学习过程中的一点个人总结，用于巩固新的知识。这里我从一个小的切入点来了解虚拟内存的工作机制：当CPU读取需要读取内存数据时，虚拟内存是如何为其服务的。

全文均是从《深入理解计算机系统》这本书中总结而来。
<!--more-->

### 基本概念

为了能够说明在CPU需要访问数据时，虚拟内存是如何为其服务的，需要先了解几个基本概念

#### CPU寻址

有两种基本的寻址方式：**物理寻址**和**虚拟寻址**

**物理寻址**

计算机的主存被组织成一个由M个连续**字节大小**的单元组成的数组。每字节都有一个唯一的**物理地址**(Physical Address, PA)。CPU根据物理地址来访问主存的方式称为**物理寻址**。

**虚拟寻址**

使用虚拟寻址，CPU通过生成一个虚拟地址(Virtual Address, VA)来访问主存，这个虚拟地址由CPU芯片上一个叫做**内存管理单元**(Memory Management Unit, MMU)的专用硬件翻译成相应的物理地址，然后通过这个物理地址来访问主存。如下图所示：
![image](http://image.jaydenfoo.com/uploads/big/35fa76a567046b4b08191428095d23c3.PNG)

#### 地址空间

地址空间是一个非负整数地址的有序集合：{0, 1, 2, ...}

地址空间分为**虚拟地址空间**和**物理地址空间**。

虚拟地址空间是一个有N=2^n个地址的地址空间，CPU从这个地址空间中生成虚拟地址。现代操作系统通常支持32位或64位虚拟地址空间。32位的虚拟地址空间约4Gb，而64位虚拟地址空间大小高达2的10次方Gb。

物理地址空间对应与系统中物理内存的M个字节：{0, 1, 2, ..., M}

#### 虚拟内存

虚拟内存实际上是被组织为一个由存放在**磁盘**上的N个连续的字节大小的单元组成的数组。每字节都有一个虚拟地址，作为数组的索引。

虚拟内存系统将虚拟内存分割成称为**虚拟页**(Virtual Page, VP)的大小固定的块。类似的，物理内存也被分割为相同大小的**物理页**(Physical Page, PP)，与之对应。linux系统的一个页一般为4KB。

虚拟内存在磁盘上数组的部分内容会被缓存到主存中，所以在任意时刻，虚拟页面的集合都分为三个不相交的子集：
- 未分配的： VM系统还未分配的页，没有任何数据和它们相关联，也不会占用任何磁盘空间。
- 缓存的：当前已缓存在物理内存中的分配页。
- 未缓存的：未缓存在物理内存中的已分配也。

虚拟内存提供了三个重要的能力：
1. 它将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式，它高效地使用了主存。
2. 它为每个进程提供了一致的地址空间，从而简化了内存管理。
3. 它保护了每个进程的地址空间不被其他进程破坏。

#### 页表

页表是一个存在于内存中的虚拟页地址和物理页地址的映射表。虚拟内存系统使用页表来判断一个虚拟页是否被缓存在内存中。

简化版的页表结果如下图所示：

![image](http://image.jaydenfoo.com/uploads/big/55f484f8d78538eb98d4a33347f9bdc9.PNG)

有效位用于标识该虚拟页是否被缓存在主存中，如果设置了有效位，则页表中该条目存放着主存中相应的物理页的起始地址，指示这个物理页缓存了该虚拟页；如果未设置有效位，且地址为空，表明该虚拟页还未被分配，否则该地址指向该虚拟页在磁盘上的起始位置。

#### 页命中

指MMU使用虚拟页地址查询页表时，对应条目的有效位为1，包含的地址为主存中缓存该虚拟页的物理页起始地址，MMU使用这个物理地址完成虚拟地址到物理地址的翻译过程。

#### 缺页

指MMU使用虚拟地址查询页表时，对应条目的有效位为0，包含的地址为该虚拟页在磁盘上的起始位置，即该页内容还没有被缓存到主存中，这也称为**缓存不命中**。

此时MMU会触发一个**缺页异常**，内核中的**缺页异常处理程序**接管后，该程序会在内存中选择一个**牺牲页**，修改牺牲页对应的页表条目，如果该牺牲页发生了修改，会将其复制回磁盘。

然后内核从磁盘中将需要的物理页复制到上一步选择的牺牲页所在的内存位置，并更新所需虚拟页对应的页表条目。

缺页异常处理程序返回，重新启动导致缺页的指令，该指令把导致缺页的虚拟地址重新发送到MMU，但是现在，这个地址已经可以命中了。

可以看到**维护页表**和**处理缺页**均有内核程序处理，对应用程序透明。

### 回答问题

当CPU需要访问虚拟内存中的数据时，会进行如下几个步骤

1. CPU根据程序指令，需要获取内存中的数据，于是发送一个的虚拟地址(VA)到CPU芯片上的内存管理单元(MMU)。
2. MMU读取主存中的页表，根据虚拟地址找到页表中对应条目。
3. 这时有两种情况，页命中和缺页：
    - 如果页命中，则得到了所需数据的实际物理地址
    - 如果发生缺页，即对应页表条目有效位为0，说明所需的数据页在磁盘中，还没有被缓存到主存。这时会发生页交换过程，内核将磁盘中所需的数据页和内存中某个被选中的**牺牲页**进行交换，并更新**页表**。重新返回第2步执行。
4. MMU获取到所需数据的实际物理内存地址，从内存中读出数据放到CPU的寄存器中供其使用。

### Note

- 一旦一个虚拟页面被初始化了，它就在一个由内核维护的专门的`交换空间`之间换来换去。所以一个系统中被所有进程分配的虚拟内存的全部数量是受磁盘上`交换空间`的数量限制的
- 

